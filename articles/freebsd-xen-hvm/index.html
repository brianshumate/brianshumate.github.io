<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>FreeBSD Xen HVM DomU - J. Brian Shumate
    </title>
    <link rel="alternate" href="http://brianshumate.com/feed.xml" type="application/rss+xml" title="Personal journal of art &amp; nerdery">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <script src="//use.edgefonts.net/source-code-pro;bree-serif.js"></script>
    <script type="text/javascript" src="/js/highlight.pack.js"></script>
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>FreeBSD Xen HVM DomU</h1>
        <p class="author">by <span class="author">J. Brian Shumate</span><br><span class="date">January 04 2012</span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>Notes on setting up a FreeBSD Xen <span class="caps">HVM</span>&nbsp;DomU</p>
<p><span class="more"></span></p>
<p>These notes are heavily influenced by <a href="http://deadmemes.net/2011/02/26/howto-freebsd-8-2-release-hvm-guest-on-xen-4-debian-squeeze/">another guide to FreeBSD Xen DomUs</a> and they’ve been streamlined to fit my particular&nbsp;systems.</p>
<p><strong><span class="caps">PLEASE</span> NOTE: This content contains outdated and possibly irrelevant&nbsp;information.</strong></p>
<p>You might draw some insight from this information and that’s great, but
please be aware that it does not constitute a comprehensive guide and is
more just a set of notes for my own&nbsp;reference.</p>
<h2 id="lvm-storage"><span class="caps">LVM</span>&nbsp;Storage</h2>
<p>It is a good practice to use <span class="caps">LVM</span> volumes for disk partitions in Xen
environments when better alternatives are not available, so this is what I am
using for new FreeBSD DomU&nbsp;instances.</p>
<p>Assuming available space on a volume group, create similar logical&nbsp;volumes:</p>
<pre><code class="lang-bash">lvcreate -L <span class="number">20</span>G -n example-main vg1
lvcreate -L <span class="number">8</span>G  -n example-swap vg1
lvcreate -L <span class="number">200</span>G -n example-data vg1
</code></pre>
<p>This is a group of volumes representing an <span class="caps">8GB</span> volume for  swap space, a 20GB
volume to be used as the root partition, and a 200GB partition for user&nbsp;data.</p>
<h2 id="loop-device-for-iso">Loop Device for&nbsp;<span class="caps">ISO</span></h2>
<p>These notes are applicable to the Xen 3.X series, which is able to use an <span class="caps">ISO</span>
image as a boot device ala CDROM, but in the even that there are issues,
a loop device can be arranges on the host machine to provide a bootable CDROM
from&nbsp;ISO.</p>
<p>If you have problems specifying the <span class="caps">ISO</span> image directly for CDROM usage, then
you can mount a loop device on the Xen&nbsp;Dom0:</p>
<pre><code class="lang-bash">losetup <span class="operator">-f</span> /root/FreeBSD-<span class="number">8.2</span>-<span class="caps">RELEASE</span>-amd64-disc1.iso
losetup /dev/loop0
</code></pre>
<p>Once you’ve created a loop device, update the disk entry in your Xen
configuration to include an entry for the “cdrom&nbsp;drive”:</p>
<pre><code>phy:/dev/loop0,ioemu:hdd:cdrom,r
</code></pre><p>Here is a complete example Xen DomU&nbsp;configuration:</p>
<pre><code># Example FreeBSD 8.2 Xen DomU

name = &quot;example&quot;
kernel = &quot;/usr/lib/xen/boot/hvmloader&quot;
builder = &#39;hvm&#39;

memory = 2048
shadow_memory = 8

cpus = &quot;1&quot;
vcpus = &quot;0&quot;

vif = [ &#39;mac=00:23:3e:55:73:78, ip=10.10.1.76, vifname=examplewan, bridge=xenbr0&#39;,
        &#39;mac=00:23:3e:77:73:78, ip=192.168.1.76, vifname=examplelan, bridge=xenbr1&#39; ]

disk = [
    # CDROM loop device
    &#39;phy:/dev/loop0,ioemu:hdd:cdrom,r&#39;,
    &#39;phy:/dev/vg1/example-main,ioemu:hda,w&#39;,
    &#39;phy:/dev/vg1/example-swap,ioemu:hdb,w&#39;,
    &#39;phy:/dev/vg1/example-data,ioemu:hdb,w&#39;]

boot= &#39;dc&#39; # cdrom then disk
# boot=&#39;cd&#39; # disk then cdrom

serial = &#39;pty&#39;

# VNC console for installation only
sdl=0
vnc=1
vnclisten=&#39;127.0.0.1&#39;
vncconsole=1
vncpassword=&#39;&#39;
stdvga=1

on_poweroff = &#39;destroy&#39;
on_reboot = &#39;restart&#39;
on_crash = &#39;restart&#39;
</code></pre><p>You should obviously change certain values as appropriate to match your own
system configuration before trying to use the&nbsp;example.</p>
<p>If you looked closely at the configuration details, you’ll notice some <span class="caps">VNC</span>
specific directives in the example Xen DomU configuration above. This is
required for initial console connections (e.g., to install FreeBSD) as they
must be done via the VNC framebuffer until the system is aware of its actual
virtual console&nbsp;device.</p>
<p>This is typically accomplished by enabling the appropriate configuration
settings and then using an <span class="caps">SSH</span> tunnel to allow for remote VNC to&nbsp;localhost.</p>
<p>A typical ssh invocation looks like&nbsp;this:</p>
<pre><code class="lang-bash">ssh <span class="operator">-l</span> username -L <span class="number">5900</span>:localhost:<span class="number">5900</span> remote_hostname
</code></pre>
<p>You’ll want to do the following basic steps to make this kind of connection
work&nbsp;out:</p>
<ol>
<li>Initiate a proper <span class="caps">SSH</span> tunnel as in the above&nbsp;example</li>
<li>Start the Xen&nbsp;DomU</li>
<li>Use <span class="caps">VNC</span> on your local machine to connect to&nbsp;localhost</li>
</ol>
<p>Once you’ve established a console, you can complete with the&nbsp;installation.</p>
<p>You can remove the <code>loop0</code> entry from your configuration when you complete
installation and change the boot order (<code>boot=</code> in the Xen config) to <code>cd</code>
to boot from the hard disk first. There is a commented version of the
sequence in the above example DomU&nbsp;configuration.</p>
<p>FreeBSD now ships with a standard Xen <span class="caps">HVM</span> kernel configuration (XENHVM) that
among other things, will build paravirtual drivers, which will increase
network and disk performance in the DomU&nbsp;instance.</p>
<p>The Xen <code>xm</code> console can also be enabled to work properly from this kernel
with some configuration&nbsp;changes.</p>
<p>You should build a fully Xen <span class="caps">HVM</span> aware custom kernel to take full advantage
of your particular hardware environment, desired performance characteristics,
capabilities, and so&nbsp;on.</p>
<p>Here’s an example of an <span class="caps">AMD</span>-64 XENHVM kernel&nbsp;configuration:</p>
<pre><code>ident   POTRZEBIE
machine amd64
cpu     HAMMER
options VESA
options SC_PIXEL_MODE
options VGA_WIDTH90
options SC_DISABLE_REBOOT
options ATA_STATIC_ID
options SMP
options KDB_TRACE
options KDB
options INCLUDE_CONFIG_FILE
options FLOWTABLE
options MAC
options AUDIT
options HWPMC_HOOKS
options KBD_INSTALL_CDEV
options PRINTF_BUFR_SIZE=128
options _KPOSIX_PRIORITY_SCHEDULING
options P1003_1B_SEMAPHORES
options SYSVSEM
options SYSVMSG
options SYSVSHM
options STACK
options KTRACE
options SCSI_DELAY=5000
options COMPAT_FREEBSD7
options COMPAT_FREEBSD6
options COMPAT_FREEBSD5
options COMPAT_FREEBSD4
options COMPAT_FREEBSD32
options COMPAT_43TTY
options GEOM_LABEL
options GEOM_PART_GPT
options PSEUDOFS
options PROCFS
options CD9660
options MD_ROOT
options UFS_GJOURNAL
options UFS_DIRHASH
options UFS_ACL
options SOFTUPDATES
options FFS
options SCTP
options INET6
options INET
options PREEMPTION
options SCHED_ULE
options XENHVM
options NO_ADAPTIVE_RWLOCKS
options NO_ADAPTIVE_MUTEXES
options GEOM_PART_MBR
options GEOM_PART_EBR_COMPAT
options GEOM_PART_EBR
options GEOM_PART_BSD
device  isa
device  mem
device  io
device  uart_ns8250
device  xenpci
device  cpufreq
device  acpi
device  pci
device  ata
device  atadisk
device  ataraid
device  atapicd
device  atapifd
device  atapist
device  scbus
device  da
device  atkbdc
device  atkbd
device  psm
device  kbdmux
device  vga
device  splash
device  sc
device  agp
device  uart
device  miibus
device  re
device  loop
device  random
device  ether
device  vlan
device  tun
device  pty
device  md
device  gif
device  faith
device  firmware
device  bpf
</code></pre><p>To get the console working, edit <code>/boot/loader.conf</code> and  add the&nbsp;following:</p>
<pre><code>boot_multicons=&quot;YES&quot;
boot_serial=&quot;YES&quot;
comconsole_speed=115200
console=&quot;comconsole,vidconsole&quot;
</code></pre><p>Then, edit <code>/etc/ttys</code> and activate <code>ttyu0</code>:</p>
<pre><code>ttyu0    &quot;/usr/libexec/getty std.115200&quot;    dialup    on secure
</code></pre><p>Restart and you’ll see output (and login terminals) via both xm console and&nbsp;vncviewer.</p>
<p>Now you’re ready to complete installation and configuration of the new DomU
as you’d like, such as public network interface configuration, enabling <span class="caps">SSH</span>
access,&nbsp;etc.</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="nav"><a href="/"><i class="class fa fa-cube"></i></a></div>
        <section class="about"><h4 id="by-day">By day</h4>
<p>Fighting for the user by resolving issues in distributed NoSQL database
environments and writing decent documentation.<br><br></p>
<h4 id="by-night">By night</h4>
<p>Writing poetry, technical words, and making visual art while communing with
Earth’s finest Lake.</p>
<p>♥ <a href="/personal-projects.html">Personal projects</a></p>
<h4 id="social">Social</h4>
<ul>
<li><a href="http://500px.com/brianshumate">500px</a></li>
<li><a href="https://github.com/brianshumate">GitHub</a></li>
<li><a href="https://chat.meatspac.es/">Meatspace Chat</a></li>
<li><a href="https://twitter.com/brianshumate">Twitter</a></li>
<li>IRC: <code>bshumate</code></li>
</ul>

        </section>
        <section class="copy">
          <p>&copy; 2015 J. Brian Shumate</p>
        </section>
      </div>
    </footer>
    <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', 'UA-47374715-2', 'auto');ga('send', 'pageview');</script>
  </body>
</html>