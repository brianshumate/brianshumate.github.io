<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>Riak on FreeBSD ZFS Jails - J. Brian Shumate
    </title>
    <link rel="alternate" href="http://brianshumate.com/feed.xml" type="application/rss+xml" title="Personal journal of art &amp; nerdery">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <script src="//use.edgefonts.net/source-code-pro;bree-serif.js"></script>
    <script type="text/javascript" src="/js/highlight.pack.js"></script>
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>Riak on FreeBSD ZFS Jails</h1>
        <p class="author">by <span class="author">J. Brian Shumate</span><br><span class="date">May 23 2012</span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>This is a ramshackle and slipshod introduction to establishing a specific
flavor of FreeBSD environment under which to <em>evaluate</em>, <em>test</em>, or <em>play</em>
with <a href="http://basho.com/products/riak-overview/">Riak</a>, the fantastic
distributed database by Basho Technologies,&nbsp;Inc.</p>
<p><span class="more"></span></p>
<p><strong><span class="caps">PLEASE</span> NOTE: This content contains outdated and possibly irrelevant&nbsp;information.</strong></p>
<p>The configuration and processes described in this guide <strong>should not</strong>
be construed as advice for use in production environments. Providing
such information is beyond the scope of this guide as&nbsp;well.</p>
<h2 id="goals-for-this-guide">Goals For This&nbsp;Guide</h2>
<p>Let’s get a clear understanding of what I’m going to be describing to you in
this guide out of the way before we roll up our sleeves and commence to hasty
typing, bug smashing, and eventual triumphant success with accompanying
celebratory&nbsp;beverages.</p>
<p>The point of this guide is do something closely resembling the following on
my modest bare metal quad-core machine with only <span class="caps">16GB</span> RAM, and approximately 200GB of SAS 10k rotational&nbsp;storage:</p>
<ol>
<li>Install FreeBSD (I am using 8.3 for my example system) on suitable hardware for running a small <strong>test</strong> Riak&nbsp;cluster.</li>
<li>Configure the system to function as a jail environment host and allocate some of the available storage for a <span class="caps">ZFS</span> zpool for jail&nbsp;environments.</li>
<li>Use ezjail with <span class="caps">ZFS</span> specific functionality to create a base jail environment plus a flavor of jail which will comprise each Riak&nbsp;node</li>
<li>Creation and minimal configuration of each Riak&nbsp;node</li>
<li>Launch nodes, join nodes, and test our cluster in various&nbsp;ways</li>
<li>Discuss minimal system tuning for best use in certain&nbsp;scenarios</li>
<li>Discuss tools for operational and performance testing and monitoring of the cluster (ex: Basho Bench, Riaknostic,&nbsp;Riemann)</li>
</ol>
<h2 id="the-host-machine">The Host&nbsp;Machine</h2>
<p>The following notes pertain to work done on the physical server for establishing a jails&nbsp;environment.</p>
<h2 id="savor-the-riak-jail-flavor">Savor The Riak Jail&nbsp;Flavor</h2>
<p>We will first build and lightly configure a Riak jail flavor, so that
spinning up subsequent Riak nodes will take much less time. The goal here is
to build a Riak node, and do initial common software package installation,
but without any unique&nbsp;configuration.</p>
<h3 id="riak-dependencies-supporting-software">Riak, Dependencies <span class="amp">&amp;</span> Supporting&nbsp;Software</h3>
<ul>
<li>Riak&nbsp;1.1.2</li>
<li>Erlang&nbsp;<span class="caps">R14B04</span></li>
<li>Curl</li>
<li>Git</li>
<li>Screen</li>
<li>Sudo</li>
<li>Vim</li>
<li>Bash</li>
</ul>
<p>After the jail is booted, we can install Riak dependencies and supporting software. As of this writing and with FreeBSD 8.3-<span class="caps">RELEASE</span>, the ports tree offers Erlang R14B04, which is compatible with the Riak version 1.1.2 we’ll be&nbsp;using.</p>
<p>Use your preferred options/discretion for particular builds of the software ports listed&nbsp;below:</p>
<pre><code class="lang-bash"><span class="built_in">cd</span> /usr/ports/lang/erlang &amp;&amp; make install distclean
<span class="built_in">cd</span> /usr/ports/ftp/curl &amp;&amp; make install distclean
<span class="built_in">cd</span> /usr/ports/devel/git &amp;&amp; make install distclean
<span class="built_in">cd</span> /usr/ports/sysutils/screen &amp;&amp; make install distclean
<span class="built_in">cd</span> /usr/ports/security/<span class="built_in">sudo</span> &amp;&amp; make install distclean
<span class="built_in">cd</span> /usr/ports/editors/vim-lite &amp;&amp; make install distclean
</code></pre>
<p>Alternatively, you can install package versions of the above like&nbsp;so:</p>
<pre><code class="lang-bash">pkg_add -r curl erlang git screen <span class="built_in">sudo</span> vim-lite
</code></pre>
<h4 id="notes-for-building-riak-on-freebsd-8-3-release">Notes for Building Riak on FreeBSD&nbsp;8.3-<span class="caps">RELEASE</span></h4>
<p><em>The <span class="caps">BSD</span> make(1) dance</em>: <span class="caps">BSD</span> has its own build toolchain in addition to some
GNU build tools, such as <code>gmake</code>. This  can pose an issue when building Riak,
so we can perform a small, rather inelegant, but temporary&nbsp;workaround:</p>
<p>From within the jail&nbsp;host:</p>
<pre><code class="lang-bash"><span class="built_in">cd</span> /usr/local/jails/basejail/usr/bin
mv make bsd-make
</code></pre>
<p>From within the jail being used to build the Riak&nbsp;flavor:</p>
<pre><code class="lang-bash">ln -sf /usr/local/bin/gmake /usr/local/bin/make
</code></pre>
<p>Now we can download the Riak 1.1.2 source, and compile a <code>rel</code> release on the initial&nbsp;node:</p>
<pre><code class="lang-bash">curl -O downloads.basho.com.s3-website-us-east-<span class="number">1</span>.amazonaws.com/riak/<span class="number">1.1</span>/<span class="number">1.1</span>.<span class="number">2</span>/riak-<span class="number">1.1</span>.<span class="number">2</span>.tar.gz
tar zxf riak-<span class="number">1.1</span>.<span class="number">2</span>.tar.gz
<span class="built_in">cd</span> riak-<span class="number">1.1</span>.<span class="number">2</span>
gmake rel
</code></pre>
<p>Provided the build was successful, you now have a complete Riak node
contained in <code>rel/riak</code>. Check out the official Basho documentation on
<a href="http://docs.basho.com/riak/latest/cookbooks/Basic-Cluster-Setup/">Basic Cluster Setup</a> to learn about configuring a Riak&nbsp;cluster.</p>
<p><strong><span class="caps">NOTE</span></strong>: Don’t forget to undo the hackity <code>gmake</code>/<code>make</code> jigglings so that
you’ll be able to build ports, etc.&nbsp;later.</p>
<p>Wash hands, dry on pants and so&nbsp;forth.</p>
<p>At this point, one can also use <code>git</code> to pull in custom environment
settings, dotfiles, etc. to ease operation and administration of the&nbsp;nodes.</p>
<h2 id="system-tuning-notes">System Tuning&nbsp;Notes</h2>
<p>Here are some minimal system tuning notes. If you want more detailed
information, see Basho’s <a href="http://docs.basho.com/riak/latest/cookbooks/Linux-Performance-Tuning/">system tuning documentation</a>.</p>
<h3 id="open-files-limit">Open Files&nbsp;Limit</h3>
<p>Riak opens many files during operation; ensure that the open files limit is
set to an adequate level for operation. The default minimum value is <code>4906</code>.</p>
<h3 id="mounting-with-noatime">Mounting With&nbsp;noatime</h3>
<p>Make sure that you use the <code>noatime</code> option for mounting any volumes
which will store Riak&nbsp;data.</p>
<h2 id="clustering-notes">Clustering&nbsp;Notes</h2>
<p>After bootstrapping each node, you’ll need to assemble them into a cluster.
In this example, I’ve got five nodes using a resolvable fully qualified
domain name scheme like this: <code>riak1.example.com</code>, <code>riak2.example.com</code>,&nbsp;…</p>
<p>A great start to understanding building a basic cluster is the Basho
documentation <a href="http://docs.basho.com/riak/latest/cookbooks/Basic-Cluster-Setup/">Basic Cluster Setup</a>.</p>
<p>The simplest process for joining the nodes to form a cluster is to issue the
<code>riak-admin join</code> command from N-1 nodes instructing them to join the first
node, like&nbsp;so:</p>
<pre><code class="lang-bash">ssh riak2.example.com riak-admin join riak@riak1.example.com
Success: sent join request to <span class="string">'riak@riak1.example.com'</span>
ssh riak3.example.com riak-admin join riak@riak1.example.com
Success: sent join request to <span class="string">'riak@riak1.example.com'</span>
ssh riak4.example.com riak-admin join riak@riak1.example.com
Success: sent join request to <span class="string">'riak@riak1.example.com'</span>
ssh riak5.example.com riak-admin join riak@riak1.example.com
Success: sent join request to <span class="string">'riak@riak1.example.com'</span>
</code></pre>
<p>As shown in the above example, you should expect to see a success message for
each node’s join attempt. If there are problems, you could see an error
message&nbsp;instead.</p>
<h3 id="riak-admin-ringready">riak-admin&nbsp;ringready</h3>
<p>After a bit of time and provided you saw success messages for each join
request, you can verify that the cluster is ready with a command like this
executed from any of the&nbsp;nodes:</p>
<pre><code class="lang-bash">ssh riak1.example.com riak-admin ringready
Attempting to restart script through <span class="built_in">sudo</span> -H -u riak
<span class="caps">TRUE</span> All nodes agree on the ring [<span class="string">'riak@riak1.example.com'</span>,
                                  <span class="string">'riak@riak2.example.com'</span>,
                                  <span class="string">'riak@riak3.example.com'</span>,
                                  <span class="string">'riak@riak4.example.com'</span>,
                                  <span class="string">'riak@riak5.example.com'</span>]
</code></pre>
<p>Some other initial checks of the cluster you can try are <code>riak-admin test</code>
and gathering status through <code>riak-admin status</code> and the <span class="caps">HTTP</span>&nbsp;interface.</p>
<h3 id="riak-admin-test">riak-admin&nbsp;test</h3>
<pre><code class="lang-bash">ssh riak1.example.com riak-admin test
Attempting to restart script through <span class="built_in">sudo</span> -H -u riak
Successfully completed <span class="number">1</span> <span class="built_in">read</span>/write cycle to <span class="string">'riak@riak1.example.com'</span>
</code></pre>
<h3 id="riak-admin-status">riak-admin&nbsp;status</h3>
<h3 id="http-stats"><span class="caps">HTTP</span>&nbsp;stats</h3>
<p>Use curl to get stats from the <span class="caps">HTTP</span> interface like&nbsp;so:</p>
<pre><code class="lang-bash">curl loadbalancer.example.com/stats
</code></pre>
<p>You can run <code>curl</code> directly against your load balancer <span class="caps">IP</span> as in the
example above or against something like <code>localhost:8098</code> when on
the node directly, but you <strong>should not expose Riak directly to any public
interfaces</strong>. Always run Riak behind some kind of load balancer or reverse
proxy&nbsp;arrangement.</p>
<h2 id="diagnose-manage-monitor">Diagnose, Manage <span class="amp">&amp;</span>&nbsp;Monitor</h2>
<h3 id="diagnosing-issues">Diagnosing&nbsp;Issues</h3>
<p>One great utility for performing initial diagnosis of troubles with your
Riak cluster is <a href="http://riaknostic.basho.com">Riaknostic</a>.</p>
<p>Riaknostic ties into the <code>riak-admin</code> command, providing a <code>diag</code> subcommand
that can be run alone for a wealth of diagnostic or with options for specific&nbsp;checks.</p>
<h3 id="managing-your-cluster">Managing Your&nbsp;Cluster</h3>
<p>Riak is an operations friendly database and the included command line tools
provide an excellent management interface. You are strongly encouraged to
familiarize yourself with the <code>riak</code> and <code>riak-admin</code> commands if you will
be interacting with Riak often via the command&nbsp;line.</p>
<p>Additional tools are available for managing Riak with a more user friendly,
contemporary web user interface. The most popular of such tools is Basho’s own
<a href="http://docs.basho.com/riak/latest/references/appendices/Riak-Control/">Riak Control</a>.</p>
<h4 id="riak-control">Riak&nbsp;Control</h4>
<p>Riak Control ships with Riak and can be enabled quite easily to provide a
more visually oriented interface to Riak’s inner&nbsp;workings.</p>
<p>Riak Control provides the following functionality out of the&nbsp;box:</p>
<p>More functionality is in the works. Check out the <a href="http://docs.basho.com/riak/latest/references/appendices/Riak-Control/">official documentation for Riak Control</a> to learn&nbsp;more.</p>
<h3 id="performance-testing">Performance&nbsp;Testing</h3>
<p>A popular tool for performance testing, bulk loading keys, and other testing
odds and ends is <a href="/articles/riak-freebsd-jails-zfs/(http://docs.basho.com/riak/latest/cookbooks/Benchmarking/">Basho Bench</a>).</p>
<p>Basho Bench can performance test various aspects of a system like Riak and
then generate nice R based graphs as a final output&nbsp;option.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="http://freebsd.org">FreeBSD</a></li>
<li><a href="http://www.freebsd.org/doc/handbook/jails.html">FreeBSD&nbsp;Jails</a></li>
<li><a href="http://docs.basho.com/riak/latest/">Riak</a></li>
<li><a href="http://docs.basho.com/riak/latest/cookbooks/Basic-Cluster-Setup/">Basic Cluster&nbsp;Setup</a></li>
<li><a href="http://docs.basho.com/riak/latest/cookbooks/Linux-Performance-Tuning/">Linux Performance&nbsp;Tuning</a></li>
<li><a href="http://riaknostic.basho.com">Riaknostic</a></li>
<li><a href="https://github.com/basho/riaknostic">Riaknostic Github&nbsp;project</a></li>
<li><a href="http://docs.basho.com/riak/latest/references/appendices/Riak-Control/">Riak&nbsp;Control</a></li>
<li><a href="https://github.com/basho/riak_control">Riak Control Github&nbsp;project</a></li>
<li><a href="http://docs.basho.com/riak/latest/cookbooks/Benchmarking/">Benchmarking</a></li>
</ul>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="nav"><a href="/"><i class="class fa fa-cube"></i></a></div>
        <section class="about"><h4 id="by-day">By day</h4>
<p>Fighting for the user by resolving issues in distributed NoSQL database
environments and writing decent documentation<br><br></p>
<h4 id="by-night">By night</h4>
<p>Writing poetry, technical words, and making visual art while trying to always
be a better human being</p>
<p>♥ <a href="/personal-projects.html">Personal projects</a></p>
<h4 id="social">Social</h4>
<ul>
<li><a href="http://500px.com/brianshumate">500px</a></li>
<li><a href="https://github.com/brianshumate">GitHub</a></li>
<li><a href="https://chat.meatspac.es/">Meatspace Chat</a></li>
<li><a href="https://twitter.com/brianshumate">Twitter</a></li>
<li>IRC: <code>bshumate</code></li>
</ul>

        </section>
        <section class="copy">
          <p>&copy; 2015 J. Brian Shumate</p>
        </section>
      </div>
    </footer>
  </body>
</html>