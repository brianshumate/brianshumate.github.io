<!DOCTYPE html><html><head><title>Riak on FreeBSD ZFS Jails | Brian Shumate</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="apple-touch-icon-precomposed" sizes="57x57" href="/img/apple-touch-icon-57x57.png"><link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/apple-touch-icon-114x114.png"><link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/apple-touch-icon-72x72.png"><link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144x144.png"><link rel="apple-touch-icon-precomposed" sizes="60x60" href="/img/apple-touch-icon-60x60.png"><link rel="apple-touch-icon-precomposed" sizes="120x120" href="/img/apple-touch-icon-120x120.png"><link rel="apple-touch-icon-precomposed" sizes="76x76" href="/img/apple-touch-icon-76x76.png"><link rel="apple-touch-icon-precomposed" sizes="152x152" href="/img/apple-touch-icon-152x152.png"><link rel="icon" type="image/png" href="/img/favicon-196x196.png" sizes="196x196"><link rel="icon" type="image/png" href="/img/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32"><link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16"><link rel="icon" type="image/png" href="/img/favicon-128.png" sizes="128x128"><meta name="application-name" content="Brian Shumate"><meta name="msapplication-TileColor" content="#F5AB35"><meta name="msapplication-TileImage" content="/img/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="/img/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="/img/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="/img/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="/img/mstile-310x310.png"><link rel="stylesheet" href="/css/site.css"><script src="//use.edgefonts.net/orbitron.js"></script></head><body><header><div class="top-bar"><div class="top-bar-left"><ul class="menu"><li class="menu-text"><a href="/"><img src="/img/brand.svg" width="24" height="24" class="svg-inject brand-all"><span>Brian </span><span>Shumate</span></a></li></ul></div><div class="top-bar-right"><ul class="menu"><li><a href="/about/">About</a></li><li><a href="/articles/">Articles</a></li><li><a href="/now/">Now</a></li><li><a href="/projects/">Projects</a></li></ul></div></div></header><div id="article-layout-main"><div class="row medium-8 large-7 columns"><article id="article"><br><div class="secondary callout"><h5 id="article-meta"><a class="heading-anchor" href="#article-meta"><span></span></a>Article Meta</h5><span class="byline"><i class="fi-calendar">&#xA0;&#xA0;Published on May 23rd, 2012</i></span><br><span class="article-stats"><i class="fi-page">&#xA0;&#xA0;1265 words</i></span><br><span class="article-stats"> <i class="fi-clock">&#xA0;&#xA0;Reading time 5 min</i></span></div><hr><h1 id="riak-on-freebsd-zfs-jails"><a class="heading-anchor" href="#riak-on-freebsd-zfs-jails"><span></span></a>Riak on FreeBSD ZFS Jails</h1><div><p>This is a ramshackle and slipshod introduction to establishing a specific
flavor of FreeBSD environment under which to <em>evaluate</em>, <em>test</em>, or <em>play</em>
with <a href="http://basho.com/products/riak-overview/">Riak</a>, the fantastic
distributed database by Basho Technologies, Inc.</p>
<!--more-->
<div class="callout"><strong>PLEASE NOTE</strong>: This content contains outdated and possibly irrelevant information.</div>

<p>The configuration and processes described in this guide <strong>should not</strong>
be construed as advice for use in production environments. Providing
such information is beyond the scope of this guide as well.</p>
<h2 id="goals-for-this-guide"><a class="heading-anchor" href="#goals-for-this-guide"><span></span></a>Goals For This Guide</h2>
<p>Let&apos;s get a clear understanding of what I&apos;m going to be describing to you in
this guide out of the way before we roll up our sleeves and commence to hasty
typing, bug smashing, and eventual triumphant success with accompanying
celebratory beverages.</p>
<p>The point of this guide is do something closely resembling the following on
my modest bare metal quad-core machine with only 16GB RAM, and approximately 200GB of SAS 10k rotational storage:</p>
<ol>
<li>Install FreeBSD (I am using 8.3 for my example system) on suitable hardware for running a small <strong>test</strong> Riak cluster.</li>
<li>Configure the system to function as a jail environment host and allocate some of the available storage for a ZFS zpool for jail environments.</li>
<li>Use ezjail with ZFS specific functionality to create a base jail environment plus a flavor of jail which will comprise each Riak node</li>
<li>Creation and minimal configuration of each Riak node</li>
<li>Launch nodes, join nodes, and test our cluster in various ways</li>
<li>Discuss minimal system tuning for best use in certain scenarios</li>
<li>Discuss tools for operational and performance testing and monitoring of the cluster (ex: Basho Bench, Riaknostic, Riemann)</li>
</ol>
<h2 id="the-host-machine"><a class="heading-anchor" href="#the-host-machine"><span></span></a>The Host Machine</h2>
<p>The following notes pertain to work done on the physical server for establishing a jails environment.</p>
<h2 id="savor-the-riak-jail-flavor"><a class="heading-anchor" href="#savor-the-riak-jail-flavor"><span></span></a>Savor The Riak Jail Flavor</h2>
<p>We will first build and lightly configure a Riak jail flavor, so that
spinning up subsequent Riak nodes will take much less time. The goal here is
to build a Riak node, and do initial common software package installation,
but without any unique configuration.</p>
<h3 id="riak-dependencies-supporting-software"><a class="heading-anchor" href="#riak-dependencies-supporting-software"><span></span></a>Riak, Dependencies &amp; Supporting Software</h3>
<ul>
<li>Riak 1.1.2</li>
<li>Erlang R14B04</li>
<li>Curl</li>
<li>Git</li>
<li>Screen</li>
<li>Sudo</li>
<li>Vim</li>
<li>Bash</li>
</ul>
<p>After the jail is booted, we can install Riak dependencies and supporting software. As of this writing and with FreeBSD 8.3-RELEASE, the ports tree offers Erlang R14B04, which is compatible with the Riak version 1.1.2 we&apos;ll be using.</p>
<p>Use your preferred options/discretion for particular builds of the software ports listed below:</p>
<pre><code class="language-bash">
<span class="token function">cd</span> /usr/ports/lang/erlang <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span> distclean
<span class="token function">cd</span> /usr/ports/ftp/curl <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span> distclean
<span class="token function">cd</span> /usr/ports/devel/git <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span> distclean
<span class="token function">cd</span> /usr/ports/sysutils/screen <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span> distclean
<span class="token function">cd</span> /usr/ports/security/sudo <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span> distclean
<span class="token function">cd</span> /usr/ports/editors/vim-lite <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span> distclean
</code></pre>
<p>Alternatively, you can install package versions of the above like so:</p>
<pre><code class="language-bash">pkg_add -r curl erlang <span class="token function">git</span> <span class="token function">screen</span> <span class="token function">sudo</span> vim-lite
</code></pre>
<h4 id="notes-for-building-riak-on-freebsd-8-3-release"><a class="heading-anchor" href="#notes-for-building-riak-on-freebsd-8-3-release"><span></span></a>Notes for Building Riak on FreeBSD 8.3-RELEASE</h4>
<p><em>The BSD make(1) dance</em>: BSD has its own build toolchain in addition to some
GNU build tools, such as <code>gmake</code>. This  can pose an issue when building Riak,
so we can perform a small, rather inelegant, but temporary workaround:</p>
<p>From within the jail host:</p>
<pre><code class="language-bash"><span class="token function">cd</span> /usr/local/jails/basejail/usr/bin
<span class="token function">mv</span> <span class="token function">make</span> bsd-make
</code></pre>
<p>From within the jail being used to build the Riak flavor:</p>
<pre><code class="language-bash"><span class="token function">ln</span> -sf /usr/local/bin/gmake /usr/local/bin/make
</code></pre>
<p>Now we can download the Riak 1.1.2 source, and compile a <code>rel</code> release on the initial node:</p>
<pre><code class="language-bash">curl -O downloads.basho.com.s3-website-us-east-1.amazonaws.com/riak/1.1/1.1.2/riak-1.1.2.tar.gz
<span class="token function">tar</span> zxf riak-1.1.2.tar.gz
<span class="token function">cd</span> riak-1.1.2
gmake rel
</code></pre>
<p>Provided the build was successful, you now have a complete Riak node
contained in <code>rel/riak</code>. Check out the official Basho documentation on
<a href="http://docs.basho.com/riak/latest/cookbooks/Basic-Cluster-Setup/">Basic Cluster Setup</a> to learn about configuring a Riak cluster.</p>
<p><strong>NOTE</strong>: Don&apos;t forget to undo the hackity <code>gmake</code>/<code>make</code> jigglings so that
you&apos;ll be able to build ports, etc. later.</p>
<p>Wash hands, dry on pants and so forth.</p>
<p>At this point, one can also use <code>git</code> to pull in custom environment
settings, dotfiles, etc. to ease operation and administration of the nodes.</p>
<h2 id="system-tuning-notes"><a class="heading-anchor" href="#system-tuning-notes"><span></span></a>System Tuning Notes</h2>
<p>Here are some minimal system tuning notes. If you want more detailed
information, see Basho&apos;s <a href="http://docs.basho.com/riak/latest/cookbooks/Linux-Performance-Tuning/">system tuning documentation</a>.</p>
<h3 id="open-files-limit"><a class="heading-anchor" href="#open-files-limit"><span></span></a>Open Files Limit</h3>
<p>Riak opens many files during operation; ensure that the open files limit is
set to an adequate level for operation. The default minimum value is <code>4906</code>.</p>
<h3 id="mounting-with-noatime"><a class="heading-anchor" href="#mounting-with-noatime"><span></span></a>Mounting With noatime</h3>
<p>Make sure that you use the <code>noatime</code> option for mounting any volumes
which will store Riak data.</p>
<h2 id="clustering-notes"><a class="heading-anchor" href="#clustering-notes"><span></span></a>Clustering Notes</h2>
<p>After bootstrapping each node, you&apos;ll need to assemble them into a cluster.
In this example, I&apos;ve got five nodes using a resolvable fully qualified
domain name scheme like this: <code>riak1.example.com</code>, <code>riak2.example.com</code>, ...</p>
<p>A great start to understanding building a basic cluster is the Basho
documentation <a href="http://docs.basho.com/riak/latest/cookbooks/Basic-Cluster-Setup/">Basic Cluster Setup</a>.</p>
<p>The simplest process for joining the nodes to form a cluster is to issue the
<code>riak-admin join</code> command from N-1 nodes instructing them to join the first
node, like so:</p>
<pre><code class="language-bash"><span class="token function">ssh</span> riak2.example.com riak-admin <span class="token function">join</span> riak@riak1.example.com
Success: sent <span class="token function">join</span> request to <span class="token string">&apos;riak@riak1.example.com&apos;</span>
<span class="token function">ssh</span> riak3.example.com riak-admin <span class="token function">join</span> riak@riak1.example.com
Success: sent <span class="token function">join</span> request to <span class="token string">&apos;riak@riak1.example.com&apos;</span>
<span class="token function">ssh</span> riak4.example.com riak-admin <span class="token function">join</span> riak@riak1.example.com
Success: sent <span class="token function">join</span> request to <span class="token string">&apos;riak@riak1.example.com&apos;</span>
<span class="token function">ssh</span> riak5.example.com riak-admin <span class="token function">join</span> riak@riak1.example.com
Success: sent <span class="token function">join</span> request to <span class="token string">&apos;riak@riak1.example.com&apos;</span>
</code></pre>
<p>As shown in the above example, you should expect to see a success message for
each node&apos;s join attempt. If there are problems, you could see an error
message instead.</p>
<h3 id="riak-admin-ringready"><a class="heading-anchor" href="#riak-admin-ringready"><span></span></a>riak-admin ringready</h3>
<p>After a bit of time and provided you saw success messages for each join
request, you can verify that the cluster is ready with a command like this
executed from any of the nodes:</p>
<pre><code class="language-bash"><span class="token function">ssh</span> riak1.example.com riak-admin ringready
Attempting to restart script through <span class="token function">sudo</span> -H -u riak
TRUE All nodes agree on the ring <span class="token punctuation">[</span><span class="token string">&apos;riak@riak1.example.com&apos;</span>,
                                  <span class="token string">&apos;riak@riak2.example.com&apos;</span>,
                                  <span class="token string">&apos;riak@riak3.example.com&apos;</span>,
                                  <span class="token string">&apos;riak@riak4.example.com&apos;</span>,
                                  <span class="token string">&apos;riak@riak5.example.com&apos;</span><span class="token punctuation">]</span>
</code></pre>
<p>Some other initial checks of the cluster you can try are <code>riak-admin test</code>
and gathering status through <code>riak-admin status</code> and the HTTP interface.</p>
<h3 id="riak-admin-test"><a class="heading-anchor" href="#riak-admin-test"><span></span></a>riak-admin test</h3>
<pre><code class="language-bash"><span class="token function">ssh</span> riak1.example.com riak-admin <span class="token function">test</span>
Attempting to restart script through <span class="token function">sudo</span> -H -u riak
Successfully completed 1 read/write cycle to <span class="token string">&apos;riak@riak1.example.com&apos;</span>
</code></pre>
<h3 id="riak-admin-status"><a class="heading-anchor" href="#riak-admin-status"><span></span></a>riak-admin status</h3>
<h3 id="http-stats"><a class="heading-anchor" href="#http-stats"><span></span></a>HTTP stats</h3>
<p>Use curl to get stats from the HTTP interface like so:</p>
<pre><code class="language-bash">curl loadbalancer.example.com/stats
</code></pre>
<p>You can run <code>curl</code> directly against your load balancer IP as in the
example above or against something like <code>localhost:8098</code> when on
the node directly, but you <strong>should not expose Riak directly to any public
interfaces</strong>. Always run Riak behind some kind of load balancer or reverse
proxy arrangement.</p>
<h2 id="diagnose-manage-monitor"><a class="heading-anchor" href="#diagnose-manage-monitor"><span></span></a>Diagnose, Manage &amp; Monitor</h2>
<h3 id="diagnosing-issues"><a class="heading-anchor" href="#diagnosing-issues"><span></span></a>Diagnosing Issues</h3>
<p>One great utility for performing initial diagnosis of troubles with your
Riak cluster is <a href="http://riaknostic.basho.com">Riaknostic</a>.</p>
<p>Riaknostic ties into the <code>riak-admin</code> command, providing a <code>diag</code> subcommand
that can be run alone for a wealth of diagnostic or with options for specific
checks.</p>
<h3 id="managing-your-cluster"><a class="heading-anchor" href="#managing-your-cluster"><span></span></a>Managing Your Cluster</h3>
<p>Riak is an operations friendly database and the included command line tools
provide an excellent management interface. You are strongly encouraged to
familiarize yourself with the <code>riak</code> and <code>riak-admin</code> commands if you will
be interacting with Riak often via the command line.</p>
<p>Additional tools are available for managing Riak with a more user friendly,
contemporary web user interface. The most popular of such tools is Basho&apos;s own
<a href="http://docs.basho.com/riak/latest/references/appendices/Riak-Control/">Riak Control</a>.</p>
<h4 id="riak-control"><a class="heading-anchor" href="#riak-control"><span></span></a>Riak Control</h4>
<p>Riak Control ships with Riak and can be enabled quite easily to provide a
more visually oriented interface to Riak&apos;s inner workings.</p>
<p>Riak Control provides the following functionality out of the box:</p>
<p>More functionality is in the works. Check out the <a href="http://docs.basho.com/riak/latest/references/appendices/Riak-Control/">official documentation for Riak Control</a> to learn more.</p>
<h3 id="performance-testing"><a class="heading-anchor" href="#performance-testing"><span></span></a>Performance Testing</h3>
<p>A popular tool for performance testing, bulk loading keys, and other testing
odds and ends is <a href="(http://docs.basho.com/riak/latest/cookbooks/Benchmarking/">Basho Bench</a>).</p>
<p>Basho Bench can performance test various aspects of a system like Riak and
then generate nice R based graphs as a final output option.</p>
<h2 id="references"><a class="heading-anchor" href="#references"><span></span></a>References</h2>
<ul>
<li><a href="http://freebsd.org">FreeBSD</a></li>
<li><a href="http://www.freebsd.org/doc/handbook/jails.html">FreeBSD Jails</a></li>
<li><a href="http://docs.basho.com/riak/latest/">Riak</a></li>
<li><a href="http://docs.basho.com/riak/latest/cookbooks/Basic-Cluster-Setup/">Basic Cluster Setup</a></li>
<li><a href="http://docs.basho.com/riak/latest/cookbooks/Linux-Performance-Tuning/">Linux Performance Tuning</a></li>
<li><a href="http://riaknostic.basho.com">Riaknostic</a></li>
<li><a href="https://github.com/basho/riaknostic">Riaknostic Github project</a></li>
<li><a href="http://docs.basho.com/riak/latest/references/appendices/Riak-Control/">Riak Control</a></li>
<li><a href="https://github.com/basho/riak_control">Riak Control Github project</a></li>
<li><a href="http://docs.basho.com/riak/latest/cookbooks/Benchmarking/">Benchmarking</a></li>
</ul>
</div><hr></article></div></div></body><footer><div class="row expanded callout secondary"><div class="large-4 columns"><h5 id="-photographie"><a class="heading-anchor" href="#-photographie"><span></span></a><i class="fi-camera"> </i>PHOTOGRAPHIE</h5><div class="row small-up-4"><div class="column"><a href="https://500px.com/photo/128380667/the-mist-by-brian-shumate"><img src="/img/500px/stock-photo-128380667.jpg" alt="500px thumbnail" class="thumbnail"></a></div><div class="column"><a href="https://500px.com/photo/92822883/orb-by-brian-shumate"><img src="/img/500px/stock-photo-128380669.jpg" alt="500px thumbnail" class="thumbnail"></a></div><div class="column"><a href="https://500px.com/photo/128380671/bee-by-brian-shumate"><img src="/img/500px/stock-photo-128380671.jpg" alt="500px thumbnail" class="thumbnail"></a></div><div class="column"><a href="https://500px.com/photo/128380673/cicada-by-brian-shumate"><img src="/img/500px/stock-photo-128380673.jpg" alt="500px thumbnail" class="thumbnail"></a></div><div class="column"><a href="https://500px.com/photo/128380675/butterfly-by-brian-shumate"><img src="/img/500px/stock-photo-128380675.jpg" alt="500px thumbnail" class="thumbnail"></a></div><div class="column"><a href="https://500px.com/photo/128380677/foggy-fall-by-brian-shumate"><img src="/img/500px/stock-photo-128380677.jpg" alt="500px thumbnail" class="thumbnail"></a></div><div class="column"><a href="https://500px.com/photo/128380679/old-homestead-by-brian-shumate"><img src="/img/500px/stock-photo-128380679.jpg" alt="500px thumbnail" class="thumbnail"></a></div><div class="column"><a href="https://500px.com/photo/128380695/foggy-morning-by-brian-shumate"><img src="/img/500px/stock-photo-128380695.jpg" alt="500px thumbnail" class="thumbnail"></a></div></div></div><div class="large-4 columns"><h5 id="-choses-sociales-"><a class="heading-anchor" href="#-choses-sociales-"><span></span></a><i class="fi-at-sign"> </i>CHOSES SOCIALES<br><a href="https://twitter.com/brianshumate" title="Brian Shumate on Twitter"><i class="fi-social-twitter size-60"> </i></a><a href="https://github.com/brianshumate" title="Brian Shumate on GitHub"><i class="fi-social-github size-60"> </i></a><a href="https://500px.com/brianshumate" title="Brian Shumate on 500px"><i class="fi-social-500px size-60"> </i></a><a href="https://keybase.io/brianshumate" title="Brian Shumate on Keybase.io"><i class="fi-key size-60"> </i></a></h5></div><div class="large-4 columns"><h5 id="-de-la-fort"><a class="heading-anchor" href="#-de-la-fort"><span></span></a><i class="fi-trees"> </i>DE LA FOR&#xCA;T</h5><div id="hdt-quote" class="callout"><bloqckquote class="jsgood"><p>&#x201C;We must walk consciously only part way toward our goal, and then leap in the dark to our success.&#x201D;<br><br>&#x2014;Henry David Thoreau</p></bloqckquote><noscript><bloqckquote><p>&#x201C;We must walk consciously only part way toward our goal, and then leap in the dark to our success.&#x201D;<br><br>&#x2014;Henry David Thoreau</p></bloqckquote></noscript><p></p></div></div></div><div class="row expanded"><div class="medium-6 columns"><ul class="menu"><li><a href="/about/">About</a></li><li><a data-open="disclaimerModal">Disclaimer</a></li><li><a href="/license/">License</a></li></ul></div><div class="medium-6 columns"><ul class="menu align-right"><li class="menu-text">Copyright &#xA9; 2015 Brian Shumate</li></ul></div></div></footer><div id="disclaimerModal" data-reveal="" class="large reveal"><h1 id="disclaimer"><a class="heading-anchor" href="#disclaimer"><span></span></a>DISCLAIMER</h1><p class="lead">This is a personal website comprised of personally held opinions. All content provided on this website is for informational purposes only. Brian Shumate makes no representations as to accuracy, completeness, suitability, or validity of any information on this website and will not be liable for any errors, omissions, or delays in this information or any losses, injuries, or damages arising from its display or use. All information is provided on an as-is basis. Terms are subject to change at any time and without notice.</p><button data-close="" aria-label="Close reveal" type="button" class="close-button"><span aria-hidden="true">&#xD7;</span></button></div><script src="/js/jquery-2.1.4.min.js"></script><script src="/js/foundation.min.js"></script><script src="/js/prism.js"></script><script src="/js/app.js"></script><script src="//static.getclicky.com/js" type="text/javascript"></script><script type="text/javascript">try{ clicky.init(100614799); }catch(e){}</script><noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100614799ns.gif"></p></noscript></html>