<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width"><link rel=apple-touch-icon-precomposed sizes=57x57 href=https://brianshumate.com/apple-touch-icon-57x57.png><link rel=apple-touch-icon-precomposed sizes=114x114 href=https://brianshumate.com/apple-touch-icon-114x114.png><link rel=apple-touch-icon-precomposed sizes=72x72 href=https://brianshumate.com/apple-touch-icon-72x72.png><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://brianshumate.com/apple-touch-icon-144x144.png><link rel=apple-touch-icon-precomposed sizes=60x60 href=https://brianshumate.com/apple-touch-icon-60x60.png><link rel=apple-touch-icon-precomposed sizes=120x120 href=https://brianshumate.com/apple-touch-icon-120x120.png><link rel=apple-touch-icon-precomposed sizes=76x76 href=https://brianshumate.com/apple-touch-icon-76x76.png><link rel=apple-touch-icon-precomposed sizes=152x152 href=https://brianshumate.com/apple-touch-icon-152x152.png><link rel=icon type=image/png href=https://brianshumate.com/favicon-196x196.png sizes=196x196><link rel=icon type=image/png href=https://brianshumate.com/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=https://brianshumate.com/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://brianshumate.com/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=https://brianshumate.com/favicon-128.png sizes=128x128><meta name=application-name content="Brian Shumate"><meta name=msapplication-TileColor content=#FFFFFF><meta name=msapplication-TileImage content=https://brianshumate.com/mstile-144x144.png><meta name=msapplication-square70x70logo content=https://brianshumate.com/mstile-70x70.png><meta name=msapplication-square150x150logo content=https://brianshumate.com/mstile-150x150.png><meta name=msapplication-wide310x150logo content=https://brianshumate.com/mstile-310x150.png><meta name=msapplication-square310x310logo content=https://brianshumate.com/mstile-310x310.png><meta name=author content="Brian Shumate"><meta name=description content="Personal website and research hub of Brian Shumate"><meta name=keywords content=website,artist,engineer,personal><base href=https://brianshumate.com/articles/riak-on-freebsd-zfs-jails/><title>Riak on Freebsd ZFS Jails · Brian Shumate</title><link rel=canonical href=https://brianshumate.com/articles/riak-on-freebsd-zfs-jails/><link rel=stylesheet href=https://brianshumate.com/css/brian.min.8f23bbcf03df96851b5b03ca843d0c18a5c3a0876487ed6fc8c0d3cfe1463b36.css integrity="sha256-jyO7zwPfloUbWwPKhD0MGKXDoIdkh&#43;1vyMDTz&#43;FGOzY=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://brianshumate.com/fonts/css/ibm-plex.min.css crossorigin=anonymous media=screen></head><body><main class=wrapper><nav class=navigation><section class=container><canvas class=zdg-global-canvas width=26 height=26></canvas>
<a class=navigation-title href=https://brianshumate.com>Brian Shumate</a><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://brianshumate.com/articles/>Articles</a></li><li class=navigation-item><a class=navigation-link href=https://brianshumate.com/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=https://brianshumate.com/contact/>Contact</a></li><li class=navigation-item><a class=navigation-link href=https://brianshumate.com/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Riak on Freebsd ZFS Jails</h1></div><div class=post-meta><div class=date><span class=posted-on>→&nbsp;
<time datetime=2012-05-23T13:22:36Z>May 23, 2012</time></span>
&nbsp;
•&nbsp;
7 minutes read</span></div></div></header><div><p>This is a ramshackle and slipshod introduction to establishing a specific
flavor of FreeBSD environment under which to <em>evaluate</em>, <em>test</em>, or <em>play</em>
with <a href=http://basho.com/products/riak-overview/>Riak</a>, the fantastic
distributed database by Basho Technologies, Inc.</p><p><strong>PLEASE NOTE</strong>: This content contains outdated and possibly irrelevant information.</p><p>The configuration and processes described in this guide <strong>should not</strong>
be construed as advice for use in production environments. Providing
such information is beyond the scope of this guide as well.</p><h2 id=goals-for-this-guide>Goals For This Guide</h2><p>Let&rsquo;s get a clear understanding of what I&rsquo;m going to be describing to you in
this guide out of the way before we roll up our sleeves and commence to hasty
typing, bug smashing, and eventual triumphant success with accompanying
celebratory beverages.</p><p>The point of this guide is do something closely resembling the following on
my modest bare metal quad-core machine with only 16GB RAM, and approximately 200GB of SAS 10k rotational storage:</p><ol><li>Install FreeBSD (I am using version 8.3 for my example system) on suitable hardware for running a small <strong>test</strong> Riak cluster.</li><li>Configure the system to function as a jail environment host and allocate some of the available storage for a ZFS zpool for jail environments.</li><li>Use ezjail with ZFS specific functionality to create a base jail environment plus a flavor of jail which will comprise each Riak node</li><li>Creation and minimal configuration of each Riak node</li><li>Launch nodes, join nodes, and test our cluster in various ways</li><li>Discuss minimal system tuning for best use in certain scenarios</li><li>Discuss tools for operational and performance testing and monitoring of the cluster (ex: Basho Bench, Riaknostic, Riemann)</li></ol><h2 id=the-host-machine>The Host Machine</h2><p>The following notes pertain to work done on the physical server for establishing a jails environment.</p><h2 id=savor-the-riak-jail-flavor>Savor The Riak Jail Flavor</h2><p>We will first build and lightly configure a Riak jail flavor, so that
spinning up subsequent Riak nodes will take much less time. The goal here is
to build a Riak node, and do initial common software package installation,
but without any unique configuration.</p><h3 id=riak-dependencies-supporting-software>Riak, Dependencies &amp; Supporting Software</h3><ul><li>Riak 1.1.2</li><li>Erlang R14B04</li><li>Curl</li><li>Git</li><li>Screen</li><li>Sudo</li><li>Vim</li><li>Bash</li></ul><p>After the jail is booted, we can install Riak dependencies and supporting software. As of this writing and with FreeBSD 8.3-RELEASE, the ports tree offers Erlang R14B04, which is compatible with the Riak version 1.1.2 we&rsquo;ll be using.</p><p>Use your preferred options/discretion for particular builds of the software ports listed below:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>cd</span> /usr/ports/lang/erlang <span class=o>&amp;&amp;</span> make install distclean <span class=o>&amp;&amp;</span> <span class=se>\
</span><span class=se></span>  <span class=nb>cd</span> /usr/ports/ftp/curl <span class=o>&amp;&amp;</span> make install distclean <span class=o>&amp;&amp;</span> <span class=se>\
</span><span class=se></span>  <span class=nb>cd</span> /usr/ports/devel/git <span class=o>&amp;&amp;</span> make install distclean <span class=o>&amp;&amp;</span> <span class=se>\
</span><span class=se></span>  <span class=nb>cd</span> /usr/ports/sysutils/screen <span class=o>&amp;&amp;</span> make install distclean <span class=o>&amp;&amp;</span> <span class=se>\
</span><span class=se></span>  <span class=nb>cd</span> /usr/ports/security/sudo <span class=o>&amp;&amp;</span> make install distclean <span class=o>&amp;&amp;</span> <span class=se>\
</span><span class=se></span>  <span class=nb>cd</span> /usr/ports/editors/vim-lite <span class=o>&amp;&amp;</span> make install distclean</code></pre></div><p>Alternatively, you can install package versions of the above like so:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ pkg_add -r curl erlang git screen sudo vim-lite</code></pre></div><h4 id=notes-for-building-riak-on-freebsd-8-3-release>Notes for Building Riak on FreeBSD 8.3-RELEASE</h4><p><em>The BSD make(1) dance</em>: BSD has its own build toolchain in addition to some
GNU build tools, such as <code>gmake</code>. This can pose an issue when building Riak,
so we can perform a small, rather inelegant, but temporary workaround:</p><p>From within the jail host:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>cd</span> /usr/local/jails/basejail/usr/bin
$ sudo mv make bsd-make</code></pre></div><p>From within the jail being used to build the Riak flavor:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ sudo ln -sf /usr/local/bin/gmake /usr/local/bin/make</code></pre></div><p>Now we can download the Riak 1.1.2 source, and compile a <code>rel</code> release on the initial node:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>export</span> <span class=nv>RURL</span><span class=o>=</span>downloads.basho.com.s3-website-us-east-1.amazonaws.com/
$ curl -O <span class=s2>&#34;</span><span class=nv>$RURL</span><span class=s2>&#34;</span>/riak/1.1/1.1.2/riak-1.1.2.tar.gz
$ tar zxf riak-1.1.2.tar.gz
$ <span class=nb>cd</span> riak-1.1.2
$ gmake rel</code></pre></div><p>Provided the build was successful, you now have a complete Riak node
contained in <code>rel/riak</code>. Check out the official Basho documentation on
<a href=http://docs.basho.com/riak/latest/cookbooks/Basic-Cluster-Setup/>Basic Cluster Setup</a> to learn about configuring a Riak cluster.</p><p><strong>NOTE</strong>: Don&rsquo;t forget to undo the hackity <code>gmake</code>/<code>make</code> stuff so that
you&rsquo;ll be able to build ports, etc. later.</p><p>Wash hands, dry on pants and so forth.</p><p>At this point, one can also use <code>git</code> to pull in custom environment
settings, dotfiles, etc. to ease operation and administration of the nodes.</p><h2 id=system-tuning-notes>System Tuning Notes</h2><p>Here are some minimal system tuning notes. If you want more detailed
information, see Basho&rsquo;s <a href=http://docs.basho.com/riak/latest/cookbooks/Linux-Performance-Tuning/>system tuning documentation</a>.</p><h3 id=open-files-limit>Open Files Limit</h3><p>Riak opens many files during operation; ensure that the open files limit is
set to an adequate level for operation. The default minimum value is <code>4906</code>.</p><h3 id=mounting-with-noatime>Mounting With noatime</h3><p>Make sure that you use the <code>noatime</code> option for mounting any volumes
which will store Riak data.</p><h2 id=clustering-notes>Clustering Notes</h2><p>After bootstrapping each node, you&rsquo;ll need to assemble them into a cluster.
In this example, I&rsquo;ve got five nodes using a resolvable fully qualified
domain name scheme like this: <code>riak1.example.com</code>, <code>riak2.example.com</code>, &hellip;</p><p>A great start to understanding building a basic cluster is the Basho
documentation <a href=http://docs.basho.com/riak/latest/cookbooks/Basic-Cluster-Setup/>Basic Cluster Setup</a>.</p><p>The simplest process for joining the nodes to form a cluster is to issue the
<code>riak-admin join</code> command from N-1 nodes instructing them to join the first
node, like so:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ ssh riak2.example.com riak-admin join riak@riak1.example.com
Success: sent join request to <span class=s1>&#39;riak@riak1.example.com&#39;</span>
$ ssh riak3.example.com riak-admin join riak@riak1.example.com
Success: sent join request to <span class=s1>&#39;riak@riak1.example.com&#39;</span>
$ ssh riak4.example.com riak-admin join riak@riak1.example.com
Success: sent join request to <span class=s1>&#39;riak@riak1.example.com&#39;</span>
$ ssh riak5.example.com riak-admin join riak@riak1.example.com
Success: sent join request to <span class=s1>&#39;riak@riak1.example.com&#39;</span></code></pre></div><p>As shown in the above example, you should expect to see a success message for
each node&rsquo;s join attempt. If there are problems, you could see an error
message instead.</p><h3 id=riak-admin-ringready>riak-admin ringready</h3><p>After a bit of time and provided you saw success messages for each join
request, you can verify that the cluster is ready with a command like this
executed from any of the nodes:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ ssh riak1.example.com riak-admin ringready
Attempting to restart script through sudo -H -u riak
TRUE All nodes agree on the ring <span class=o>[</span><span class=s1>&#39;riak@riak1.example.com&#39;</span>,
                                  <span class=s1>&#39;riak@riak2.example.com&#39;</span>,
                                  <span class=s1>&#39;riak@riak3.example.com&#39;</span>,
                                  <span class=s1>&#39;riak@riak4.example.com&#39;</span>,
                                  <span class=s1>&#39;riak@riak5.example.com&#39;</span><span class=o>]</span></code></pre></div><p>Some other initial checks of the cluster you can try are <code>riak-admin test</code>
and gathering status through <code>riak-admin status</code> and the HTTP interface.</p><h3 id=riak-admin-test>riak-admin test</h3><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ ssh riak1.example.com riak-admin <span class=nb>test</span>
Attempting to restart script through sudo -H -u riak
Successfully completed <span class=m>1</span> read/write cycle to <span class=s1>&#39;riak@riak1.example.com&#39;</span></code></pre></div><h3 id=riak-admin-status>riak-admin status</h3><h3 id=http-stats>HTTP stats</h3><p>Use curl to get stats from the HTTP interface like so:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ curl loadbalancer.example.com/stats</code></pre></div><p>You can run <code>curl</code> directly against your load balancer IP as in the
example above or against something like <code>localhost:8098</code> when on
the node directly, but you <strong>should not expose Riak directly to any public
interfaces</strong>.</p><p>Instead, always run Riak behind some kind of load balancer or reverse
proxy arrangement.</p><h2 id=diagnose-manage-monitor>Diagnose, Manage &amp; Monitor</h2><h3 id=diagnosing-issues>Diagnosing Issues</h3><p>One great utility for performing initial diagnosis of troubles with your
Riak cluster is <a href=http://riaknostic.basho.com>Riaknostic</a>.</p><p>Riaknostic ties into the <code>riak-admin</code> command, providing a <code>diag</code> subcommand
that can be run alone for a wealth of diagnostic or with options for specific
checks.</p><h3 id=managing-your-cluster>Managing Your Cluster</h3><p>Riak is an operations friendly database and the included command line tools
provide an excellent management interface. You are strongly encouraged to
familiarize yourself with the <code>riak</code> and <code>riak-admin</code> commands if you will
be interacting with Riak often via the command line.</p><p>Additional tools are available for managing Riak with a more user friendly,
contemporary web user interface. The most popular of such tools is Basho&rsquo;s own
<a href=http://docs.basho.com/riak/latest/references/appendices/Riak-Control/>Riak Control</a>.</p><h4 id=riak-control>Riak Control</h4><p>Riak Control ships with Riak and can be enabled quite easily to provide a
more visually oriented interface to Riak&rsquo;s inner workings.</p><p>Riak Control provides the following functionality out of the box:</p><p>More functionality is in the works. Check out the <a href=http://docs.basho.com/riak/latest/references/appendices/Riak-Control/>official documentation for Riak Control</a> to learn more.</p><h3 id=performance-testing>Performance Testing</h3><p>A popular tool for performance testing, bulk loading keys, and other testing
odds and ends is <a href=(http://docs.basho.com/riak/latest/cookbooks/Benchmarking/)>Basho Bench</a>.</p><p>Basho Bench can performance test various aspects of a system like Riak and
then generate nice R based graphs as a final output option.</p><h2 id=references>References</h2><ul><li><a href=http://freebsd.org>FreeBSD</a></li><li><a href=http://www.freebsd.org/doc/handbook/jails.html>FreeBSD Jails</a></li><li><a href=http://docs.basho.com/riak/latest/>Riak</a></li><li><a href=http://docs.basho.com/riak/latest/cookbooks/Basic-Cluster-Setup/>Basic Cluster Setup</a></li><li><a href=http://docs.basho.com/riak/latest/cookbooks/Linux-Performance-Tuning/>Linux Performance Tuning</a></li><li><a href=http://riaknostic.basho.com>Riaknostic</a></li><li><a href=https://github.com/basho/riaknostic>Riaknostic Github project</a></li><li><a href=http://docs.basho.com/riak/latest/references/appendices/Riak-Control/>Riak Control</a></li><li><a href=https://github.com/basho/riak_control>Riak Control Github project</a></li><li><a href=http://docs.basho.com/riak/latest/cookbooks/Benchmarking/>Benchmarking</a></li></ul></div><footer></footer></article></section></div><footer class=footer><hr class=fadehr><section class=container><p id=serendipity></p>© 2019
Brian Shumate · All Rights Reserved</section></footer></main></body><script src=https://brianshumate.com/js/cash.min.js></script><script src=https://brianshumate.com/js/zdog.dist.min.js></script><script src=https://brianshumate.com/js/app.js type=text/javascript async defer></script></html>